"use strict";angular.module("discussionShowApp",["discussionShowApp.services","ngCookies","ngResource","ngSanitize","ngRoute","uiGmapgoogle-maps","xeditable","restangular"]).config(["$interpolateProvider",function(n){n.startSymbol("[["),n.endSymbol("]]")}]).config(function(n){n.configure({v:"3.17",language:"es",sensor:!1,libraries:"drawing,geometry,visualization"})}).run(function(n){n.theme="bs3"}).constant("CFG",{DELAY:600,RANGE_STEPS:20,GMAPS_ZOOM:14,GPS_CENTER_POS:{lat:41.4926867,lng:2.3613954},PROCESS_PARTICIPATION_STATE:{DRAFT:1,PRESENTATION:2,DEBATE:3,CLOSED:4}}),angular.module("discussionShowApp").controller("MainCtrl",["CFG","uiGmapGoogleMapApi","$scope","$timeout","$routeParams","$log","Restangular","$q","Security","$http",function(n,o,e,t,s,i,c,a,r,u){e.init=function(o,t,s,c){e.discussion=angular.fromJson(o),e.comments=angular.fromJson(t),e.is_logged=s,e.username=c,e.canVotePromise=r.canVoteInProcessParticipation(e.discussion.state,e.is_logged),e.map={zoom:n.GMAPS_ZOOM,center:{latitude:o.gps.latitude,longitude:o.gps.longitude},control:{}},e.map.options={scrollwheel:!0,draggable:!0,maxZoom:20},e.currentPage=1,e.comment.update(),e.fetchProposalAnswersTotalVotesCount(),e.CFG=n,i.log("[init] discussion",e.discussion),i.log("[init] comments",e.comments),i.log("[init] pages",e.pages)},e.vote=function(n){e.canVotePromise.then(function(){var o=Routing.generate("api_post_processparticipation_answers_vote",{id:e.discussion.id,answer_id:n.id}),t=c.all(o.substring(1));if(n.user_has_vote_this_proposal_answer)t.remove().then(function(){n.votes_count--,n.user_has_vote_this_proposal_answer=!1,e.discussion.user_already_vote=!1,e.fetchProposalAnswersTotalVotesCount()});else{var s={comment:null};t.post(s).then(function(){n.votes_count++,n.user_has_vote_this_proposal_answer=!0,e.discussion.user_already_vote=!0,e.fetchProposalAnswersTotalVotesCount()})}},function(){e.showModal.login()})},e.comment={like:function(n,o){e.canVotePromise.then(function(){var t=Routing.generate("api_post_processparticipation_comments_like",{id:e.discussion.id,comment_id:n.id}),s=c.all(t.substring(1));n.user_already_like?s.remove().then(function(n){e.comments.comments[o]=n}):s.post().then(function(n){e.comments.comments[o]=n})},function(){e.showModal.login()})},unlike:function(n,o){e.canVotePromise.then(function(){var t=Routing.generate("api_post_processparticipation_comments_unlike",{id:e.discussion.id,comment_id:n.id}),s=c.all(t.substring(1));n.user_already_unlike?s.remove().then(function(n){e.comments.comments[o]=n}):s.post().then(function(n){e.comments.comments[o]=n})},function(){e.showModal.login()})},post:function(n,o){e.canVotePromise.then(function(){var t=Routing.generate("api_post_processparticipation_comments",{id:e.discussion.id}),s=c.all(t.substring(1));o?(n.parent=o.id,s.post(n).then(function(e){void 0===o.answers&&(o.answers={},o.answers.comments=[]),o.answers.comments.push(e),e.likes_count=0,e.unlikes_count=0,jQuery("#answer-comment-"+o.id).find("input:text, textarea").val(""),n.title=void 0,n.comment=void 0})):s.post(n).then(function(o){o.likes_count=0,o.unlikes_count=0,e.comments.comments.unshift(o),jQuery("#top-level-comments-form").find("input:text, textarea").val(""),n.title=void 0,n.comment=void 0})},function(){e.showModal.login()})},put:function(n){e.canVotePromise.then(function(){var o=Routing.generate("api_put_processparticipation_comments",{id:e.discussion.id,comment_id:n.id}),t=c.all(o.substring(1)),s={title:n.title,comment:n.comment};t.customPUT(s).then(function(){})},function(){e.showModal.login()})},showAnswerCommentForm:function(n){jQuery("#answer-comment-"+n).toggleClass("hide")},getListLevel1:function(n){u.get(Routing.generate("api_get_processparticipation_comments",{id:e.discussion.id,page:n},!1)).success(function(o){e.comments=o,e.comment.update(),e.currentPage=n})},getAnswers:function(n){u.get(Routing.generate("api_get_processparticipation_comments_childrens",{id:e.discussion.id,comment_id:n.id},!1)).success(function(o){n.answers=o,e.disableShowAnswersButton=!0,i.log("[getAnswers]",n)})},update:function(){e.pages=Math.ceil(e.comments.count/10)},checkIfPostIsAvailable:function(){e.canVotePromise.then(function(){},function(){e.showModal.login()})}},e.showModal={login:function(){e.is_logged||jQuery("#login-modal-form").modal({show:!0})}},e.range=function(n){return new Array(n)},e.getUserProfileUrl=function(n){return Routing.generate("fos_user_profile_public_show",{username:n})},e.fetchProposalAnswersTotalVotesCount=function(){if(e.discussion){for(var n=0,o=0;o<e.discussion.proposal_answers.length;o++)n+=e.discussion.proposal_answers[o].votes_count;0===n&&(n=.001),e.discussion.proposal_answers.total_votes=n}}}]);var services=angular.module("discussionShowApp.services",[]);services.factory("Security",function(n,o,e){return{canVoteInProcessParticipation:function(o,t){return n(function(n,s){t?o===e.PROCESS_PARTICIPATION_STATE.DEBATE&&t&&n():s()})}}});